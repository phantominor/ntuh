<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neurology Exam Converter (Full Ver.)</title>
    <style>
        :root {
            --primary: #2c3e50;      /* 深藍 - 標題 */
            --accent: #3498db;       /* 亮藍 - 重點 */
            --bg: #f0f2f5;           /* 背景灰 */
            --card-bg: #ffffff;      /* 卡片白 */
            --border: #dce1e5;       /* 邊框 */
            --text-main: #333;       /* 主要文字 */
            --danger: #e74c3c;       /* 異常/紅色 */
            --success: #27ae60;      /* 正常/綠色 */
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Layout --- */
        .input-panel {
            flex: 2;
            overflow-y: auto;
            padding-right: 15px;
            padding-bottom: 50px;
        }

        .output-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            height: 100%;
        }

        /* --- Card Styles --- */
        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .card-header {
            background: var(--primary);
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            font-weight: 600;
        }
        .card-header:hover { opacity: 0.95; }

        .abnormal-summary {
            font-size: 0.85rem;
            color: #ffadad; /* 淺紅色警示 */
            font-weight: normal;
            margin-left: 15px;
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .card-body {
            padding: 15px;
            display: block;
        }
        .card-body.collapsed { display: none; }

        /* --- Sub-sections --- */
        h3 {
            font-size: 0.9rem;
            color: var(--primary);
            border-left: 4px solid var(--accent);
            padding-left: 8px;
            margin: 15px 0 10px 0;
            background: #f8fbff;
            padding: 6px 10px;
        }

        /* --- Form Elements --- */
        .form-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }

        label {
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 140px;
            color: #555;
        }

        input[type="text"], select, input[type="number"] {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        input[type="text"]:focus { border-color: var(--accent); outline: none; }

        /* --- Toggle Buttons --- */
        .toggle-group {
            display: flex;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ccc;
        }
        .toggle-btn {
            padding: 5px 12px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: bold;
            color: #999;
            transition: all 0.2s;
        }
        /* Style for Positive/Normal State */
        .toggle-btn.active-pos { background: var(--success); color: white; } /* 正常 (+) */
        .toggle-btn.active-neg { background: var(--danger); color: white; } /* 異常 (-) or Pathological */
        
        /* Special case: For items where (-) is normal (like Babinski, signs) */
        .toggle-btn.normal-neg { background: var(--success); color: white; } 
        .toggle-btn.abnormal-pos { background: var(--danger); color: white; }

        /* --- Sliders --- */
        .slider-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type=range] { flex: 1; cursor: pointer; }
        .slider-val { font-weight: bold; color: var(--accent); min-width: 30px; text-align: center; }

        /* --- EOM Grid --- */
        .eom-container {
            display: flex;
            gap: 40px;
            justify-content: center;
            margin: 10px 0;
            background: #fafafa;
            padding: 10px;
            border-radius: 8px;
        }
        .eye-box { text-align: center; }
        .eye-grid {
            display: grid;
            grid-template-columns: 40px 40px 40px;
            grid-template-rows: 40px 40px 40px;
            gap: 2px;
            margin-top: 5px;
        }
        .eye-input {
            width: 100%; height: 100%;
            text-align: center;
            border: 1px solid #ddd;
            font-size: 0.9rem;
            padding: 0;
        }
        .eye-input:focus { background: #eef; border-color: var(--accent); }
        .eye-spacer { background: transparent; }

        /* --- Output --- */
        textarea#result {
            flex-grow: 1;
            width: 100%;
            margin-bottom: 10px;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
            line-height: 1.4;
            white-space: pre;
            overflow-x: auto;
        }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-action {
            flex: 1; padding: 10px; border: none; border-radius: 4px;
            font-weight: 600; cursor: pointer; color: white;
        }
        .btn-convert { background: var(--primary); }
        .btn-copy { background: var(--success); }
        .btn-reset { background: #7f8c8d; }

    </style>
</head>
<body>

<div class="input-panel">
    <div class="card" data-section="Scores">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Consciousness & Scores</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <div class="form-row">
                <label>GCS</label>
                <div style="flex:1; display:flex; gap:5px;">
                    <select id="gcs_e" class="monitored" data-normal="4"><option value="4">E4</option><option value="3">E3</option><option value="2">E2</option><option value="1">E1</option></select>
                    <select id="gcs_v" class="monitored" data-normal="5"><option value="5">V5</option><option value="4">V4</option><option value="3">V3</option><option value="2">V2</option><option value="1">V1</option><option value="E">Vt</option><option value="A">Va</option></select>
                    <select id="gcs_m" class="monitored" data-normal="6"><option value="6">M6</option><option value="5">M5</option><option value="4">M4</option><option value="3">M3</option><option value="2">M2</option><option value="1">M1</option></select>
                </div>
            </div>
            <div class="form-row">
                <label>Status</label>
                <input type="text" id="gcs_status" value="alert and aware" class="monitored" data-normal="alert and aware">
            </div>
            <div class="form-row">
                <label>NIHSS</label>
                <input type="text" id="nihss_detail" value="{000 000 0000 00000}" style="font-family: monospace;">
                <span style="margin: 0 10px;">=</span>
                <input type="number" id="nihss_total" value="0" style="width:60px; flex:0;" class="monitored" data-normal="0">
            </div>
        </div>
    </div>

    <div class="card" data-section="Cognition">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Cognition</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <h3>High Cortical Function</h3>
            <div class="form-row"><label>Category naming</label><input type="text" id="cog_cat" value="fair" class="monitored" data-normal="fair"></div>
            <div class="form-row"><label>Luria test</label><input type="text" id="cog_luria" value="fair" class="monitored" data-normal="fair"></div>
            <div class="form-row"><label>Letter # seq</label><input type="text" id="cog_seq" value="fair" class="monitored" data-normal="fair"></div>
            
            <h3>Primitive Reflexes (Normal: -)</h3>
            <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:10px;">
                <div id="prim_container" style="display:contents;"></div>
            </div>

            <h3>Language</h3>
            <div class="form-row"><label>Fluency</label><input type="text" id="lang_fluency" value="fair, without dysarthria" class="monitored" data-normal="fair, without dysarthria"></div>
            <div class="form-row"><label>Comprehension</label><input type="text" id="lang_comp" value="could obey 3-step orders" class="monitored" data-normal="could obey 3-step orders"></div>
            <div class="form-row"><label>Reading</label><input type="text" id="lang_read" value="correctly read aloud" class="monitored" data-normal="correctly read aloud"></div>
            <div class="form-row"><label>Naming</label><input type="text" id="lang_name" value="fine with pen, phone, watch" class="monitored" data-normal="fine with pen, phone, watch"></div>
            <div class="form-row"><label>Repeating</label><input type="text" id="lang_repeat" value="fine" class="monitored" data-normal="fine"></div>
            
            <h3>Neglect</h3>
            <div class="form-row"><label>Neglect</label><input type="text" id="neglect" value="no neglect to visual, tactile, auditory" class="monitored" data-normal="no neglect to visual, tactile, auditory"></div>
        </div>
    </div>

    <div class="card" data-section="Cranial Nerves">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Cranial Nerves</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <div class="form-row"><label>CN I (Smell)</label><input type="text" id="cn1" value="unchecked"></div>
            
            <h3>CN II (Optic)</h3>
            <div class="form-row"><label>Visual Field</label><input type="text" id="cn2_vf" value="intact by confrontation" class="monitored" data-normal="intact by confrontation"></div>
            <div class="form-row"><label>Pupil Size</label><input type="text" id="cn2_pupil" value="isocoric, 3mm/3mm" class="monitored" data-normal="isocoric, 3mm/3mm"></div>
            <div class="form-row">
                <label>Light Reflex</label>
                <div style="display:flex; gap:20px;">
                    <span id="lr_l"></span> <span id="lr_r"></span>
                </div>
            </div>

            <h3>CN III, IV, VI (Oculomotor)</h3>
            <div class="form-row"><label>EOM</label><input type="text" id="cn3_eom" value="intact, no gaze limitation" class="monitored" data-normal="intact, no gaze limitation"></div>
            
            <div class="eom-container">
                <div class="eye-box">
                    <small>Right Eye</small>
                    <div class="eye-grid" id="grid_r"></div>
                </div>
                <div class="eye-box">
                    <small>Left Eye</small>
                    <div class="eye-grid" id="grid_l"></div>
                </div>
            </div>

            <div class="form-row"><label>Nystagmus</label><span id="nystagmus_toggle"></span></div>
            <div class="form-row"><label>Ptosis</label><span id="ptosis_toggle"></span></div>
            <div class="form-row"><label>Saccade</label><input type="text" id="cn3_saccade" value="intact" class="monitored" data-normal="intact"></div>
            <div class="form-row"><label>Pursuit</label><input type="text" id="cn3_pursuit" value="smooth" class="monitored" data-normal="smooth"></div>
            <div class="form-row"><label>Convergence</label><input type="text" id="cn3_conv" value="intact" class="monitored" data-normal="intact"></div>

            <h3>CN V, VII (Face)</h3>
            <div class="form-row"><label>Corneal Reflex</label><div style="display:flex; gap:20px;"><span id="cor_l"></span><span id="cor_r"></span></div></div>
            <div class="form-row"><label>Face Sensation</label><input type="text" id="cn5_sens" value="symmetrical, intact" class="monitored" data-normal="symmetrical, intact"></div>
            <div class="form-row"><label>Masseter</label><input type="text" id="cn5_mass" value="symmetrical" class="monitored" data-normal="symmetrical"></div>
            <div class="form-row"><label>Facial Palsy</label><input type="text" id="cn7_face" value="symmetrical, no palsy" class="monitored" data-normal="symmetrical, no palsy"></div>
            <div class="form-row"><label>Eye Closure</label><input type="text" id="cn7_eye" value="symmetrical" class="monitored" data-normal="symmetrical"></div>
            <div class="form-row"><label>Nasolabial fold</label><input type="text" id="cn7_fold" value="symmetrical" class="monitored" data-normal="symmetrical"></div>

            <h3>CN VIII - XII</h3>
            <div class="form-row"><label>Hearing</label><input type="text" id="cn8_hear" value="bilaterally intact" class="monitored" data-normal="bilaterally intact"></div>
            <div class="form-row"><label>Weber/Rinne</label><input type="text" id="cn8_tune" value="Weber midline, Rinne AC>BC" class="monitored" data-normal="Weber midline, Rinne AC>BC"></div>
            <div class="form-row"><label>Gag Reflex</label><div style="display:flex; gap:20px;"><span id="gag_l"></span><span id="gag_r"></span></div></div>
            <div class="form-row"><label>Uvula/Palate</label><input type="text" id="cn9_uvula" value="midline, elevation symmetrical" class="monitored" data-normal="midline, elevation symmetrical"></div>
            <div class="form-row"><label>Dysarthria</label><input type="text" id="cn9_dys" value="(-)" class="monitored" data-normal="(-)"></div>
            <div class="form-row"><label>Trapezius</label><input type="text" id="cn11_trap" value="symmetrical, 5/5" class="monitored" data-normal="symmetrical, 5/5"></div>
            <div class="form-row"><label>Tongue</label><input type="text" id="cn12_tongue" value="midline, no deviation" class="monitored" data-normal="midline, no deviation"></div>
        </div>
    </div>

    <div class="card" data-section="Motor">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Motor System</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <div class="form-row"><label>Inspection</label><input type="text" id="mot_insp" value="muscle wasting(-), fasciculation(-)" class="monitored" data-normal="muscle wasting(-), fasciculation(-)"></div>
            <div class="form-row"><label>Tone</label><input type="text" id="mot_tone" value="normal" class="monitored" data-normal="normal"></div>
            
            <h3>Muscle Power (0-5)</h3>
            <div id="motor_sliders"></div> </div>
    </div>

    <div class="card" data-section="Reflex">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Reflexes</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <h3>DTR (Norm: ++/++)</h3>
            <div id="dtr_list"></div> <h3>Pathologic</h3>
            <div class="form-row"><label>Babinski</label><input type="text" id="ref_bab" value="flexor/flexor" class="monitored" data-normal="flexor/flexor"></div>
            <div class="form-row"><label>Hoffman</label><input type="text" id="ref_hoff" value="-/-" class="monitored" data-normal="-/-"></div>
            <div class="form-row"><label>Tromner</label><input type="text" id="ref_trom" value="-/-" class="monitored" data-normal="-/-"></div>
        </div>
    </div>

    <div class="card" data-section="Sensory">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Sensory</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <h3>Small Fiber</h3>
            <div class="form-row"><label>Light Touch/Pin</label><input type="text" id="sen_touch" value="intact" class="monitored" data-normal="intact"></div>
            <h3>Large Fiber</h3>
            <div class="form-row"><label>Proprioception</label><input type="text" id="sen_prop" value="intact" class="monitored" data-normal="intact"></div>
            <div class="form-row"><label>Vibration</label><input type="text" id="sen_vib" value="thumb (8/8), 1st toe (8/8)" class="monitored" data-normal="thumb (8/8), 1st toe (8/8)"></div>
        </div>
    </div>

    <div class="card" data-section="Coordination">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Coordination</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <div class="form-row"><label>F-N-F</label><input type="text" id="coor_fnf" value="fair, no dysmetria" class="monitored" data-normal="fair, no dysmetria"></div>
            <div class="form-row"><label>H-K-S</label><input type="text" id="coor_hks" value="fair, no dysmetria" class="monitored" data-normal="fair, no dysmetria"></div>
            <div class="form-row"><label>RAM</label><input type="text" id="coor_ram" value="fair" class="monitored" data-normal="fair"></div>
            <div class="form-row"><label>Rebound</label><input type="text" id="coor_reb" value="(-)" class="monitored" data-normal="(-)"></div>
            <div class="form-row"><label>Truncal</label><input type="text" id="coor_trunk" value="(-)" class="monitored" data-normal="(-)"></div>
            
            <h3>Posture & Gait</h3>
            <div class="form-row"><label>Romberg</label><span id="romberg_toggle"></span></div>
            <div class="form-row"><label>Gait</label><input type="text" id="gait_pat" value="narrow-based, steady" class="monitored" data-normal="narrow-based, steady"></div>
            <div class="form-row"><label>Tandem</label><input type="text" id="gait_tandem" value="able to do" class="monitored" data-normal="able to do"></div>
        </div>
    </div>

    <div class="card" data-section="EPS">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ EPS</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <div class="form-row"><label>Face/Arm Swing</label><input type="text" id="eps_face" value="Mask(-), arm swing intact" class="monitored" data-normal="Mask(-), arm swing intact"></div>
            <div class="form-row"><label>Tremor</label><input type="text" id="eps_tremor" value="Resting(-), Action(-), Posture(-)" class="monitored" data-normal="Resting(-), Action(-), Posture(-)"></div>
            <div class="form-row"><label>Rigidity</label><input type="text" id="eps_rigid" value="(-)" class="monitored" data-normal="(-)"></div>
            <div class="form-row"><label>Bradykinesia</label><input type="text" id="eps_brady" value="(-)" class="monitored" data-normal="(-)"></div>
            <div class="form-row"><label>Parkinson Gait</label><input type="text" id="eps_gait" value="No shuffling, no freezing" class="monitored" data-normal="No shuffling, no freezing"></div>
        </div>
    </div>

    <div class="card" data-section="Autonomic">
        <div class="card-header" onclick="toggleCard(this)">
            <span>▼ Autonomic</span>
            <span class="abnormal-summary"></span>
        </div>
        <div class="card-body">
            <div class="form-row"><label>Sphincter</label><input type="text" id="auto_sph" value="incontinence (-)" class="monitored" data-normal="incontinence (-)"></div>
            <div class="form-row"><label>Dizziness</label><input type="text" id="auto_diz" value="(-)" class="monitored" data-normal="(-)"></div>
            <div class="form-row"><label>Sweating</label><input type="text" id="auto_sweat" value="normal" class="monitored" data-normal="normal"></div>
        </div>
    </div>
</div>

<div class="output-panel">
    <h2 style="margin-top:0; color:var(--primary);">Result</h2>
    <textarea id="result" spellcheck="false"></textarea>
    <div class="btn-group">
        <button class="btn-action btn-reset" onclick="resetDefaults()">Reset</button>
        <button class="btn-action btn-convert" onclick="generateReport()">Convert</button>
        <button class="btn-action btn-copy" onclick="copyResult()">Copy</button>
    </div>
</div>

<script>
    // --- 1. Dynamic UI Generation ---

    // Toggle Button Creator (Handles +/-)
    // normalVal: '+' or '-' (determines which state is green/hidden)
    function createToggle(containerId, labelPrefix, normalVal = '+') {
        const container = document.getElementById(containerId);
        if(!container) return;
        
        // Define visual classes based on what is "Normal"
        // If Normal is '+', then '+' is green(success), '-' is red(danger)
        // If Normal is '-', then '-' is green(success), '+' is red(danger)
        
        container.innerHTML = `
            <div class="toggle-group" data-normal="${normalVal}" data-label="${labelPrefix}">
                <input type="hidden" class="toggle-input monitored" value="${normalVal}" data-normal="${normalVal}">
                <button class="toggle-btn" onclick="switchToggle(this, '-')" style="border-right:1px solid #ccc">-</button>
                <button class="toggle-btn" onclick="switchToggle(this, '+')">+</button>
            </div>
        `;
        // Init visual state
        updateToggleVisual(container.querySelector('.toggle-input'));
    }

    function switchToggle(btn, val) {
        const wrapper = btn.closest('.toggle-group');
        const input = wrapper.querySelector('.toggle-input');
        input.value = val;
        updateToggleVisual(input);
        checkCardAbnormal(wrapper.closest('.card'));
    }

    function updateToggleVisual(input) {
        const wrapper = input.parentElement;
        const normalVal = wrapper.dataset.normal; // '+' or '-'
        const currentVal = input.value;
        const btns = wrapper.querySelectorAll('.toggle-btn');
        
        // Reset classes
        btns[0].className = 'toggle-btn'; // Minus button
        btns[1].className = 'toggle-btn'; // Plus button

        // Apply styles
        if (currentVal === '-') {
            // Check if '-' is normal or abnormal
            btns[0].classList.add(normalVal === '-' ? 'normal-neg' : 'active-neg');
        } else {
            // Check if '+' is normal or abnormal
            btns[1].classList.add(normalVal === '+' ? 'active-pos' : 'abnormal-pos');
        }
    }

    // Slider Creator
    function createSlider(containerId, label, id) {
        const div = document.createElement('div');
        div.className = 'form-row';
        div.innerHTML = `
            <label>${label}</label>
            <div class="slider-wrapper">
                <span style="font-size:0.8em; color:#999;">0</span>
                <input type="range" min="0" max="5" step="0.5" value="5" id="${id}" class="monitored" data-normal="5" oninput="this.nextElementSibling.innerText = this.value; checkCardAbnormal(this.closest('.card'));">
                <span class="slider-val">5</span>
            </div>
        `;
        document.getElementById(containerId).appendChild(div);
    }

    // EOM Grid Creator (Cross Shape)
    function createEOMGrid(containerId, prefix) {
        const container = document.getElementById(containerId);
        // Indices: 0:Top, 1:Left, 2:Center, 3:Right, 4:Bottom
        // Grid is 3x3. 
        // Row 1: . T .
        // Row 2: L C R
        // Row 3: . B .
        const map = [
            null, {id:'t', idx:0}, null,
            {id:'l', idx:1}, {id:'c', idx:2}, {id:'r', idx:3},
            null, {id:'b', idx:4}, null
        ];

        map.forEach(item => {
            if(item) {
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.className = 'eye-input monitored';
                inp.dataset.normal = '0'; // Normal is 0
                inp.value = '0';
                inp.id = `${prefix}_${item.id}`;
                inp.onfocus = function() { this.select(); }
                inp.oninput = function() { checkCardAbnormal(this.closest('.card')); }
                container.appendChild(inp);
            } else {
                const sp = document.createElement('div');
                sp.className = 'eye-spacer';
                container.appendChild(sp);
            }
        });
    }

    // --- 2. Logic & Interactions ---

    window.onload = function() {
        // Init Toggles
        // Primitives (Normal is -)
        ['Glabellar', 'Rooting', 'Sucking', 'Snouting', 'Grasping', 'Palmomental'].forEach(p => {
            const wrap = document.createElement('div');
            wrap.style.display="flex"; wrap.style.alignItems="center"; wrap.style.gap="5px";
            wrap.innerHTML = `<span style="font-size:0.8rem; width:80px;">${p}</span><span id="prim_${p}"></span>`;
            document.getElementById('prim_container').appendChild(wrap);
            createToggle(`prim_${p}`, p, '-'); 
        });

        // CN Toggles
        createToggle('lr_l', 'Light(L)', '+');
        createToggle('lr_r', 'Light(R)', '+');
        createToggle('nystagmus_toggle', 'Nystagmus', '-');
        createToggle('ptosis_toggle', 'Ptosis', '-');
        createToggle('cor_l', 'Corneal(L)', '+');
        createToggle('cor_r', 'Corneal(R)', '+');
        createToggle('gag_l', 'Gag(L)', '+');
        createToggle('gag_r', 'Gag(R)', '+');
        createToggle('romberg_toggle', 'Romberg', '-');

        // Init Sliders
        const m = document.getElementById('motor_sliders');
        const muscles = [
            ['Shoulder Abd (C5)', 'm_c5'], ['Elbow Flex (C6)', 'm_c6'], ['Elbow Ext (C7)', 'm_c7'],
            ['Wrist Flex (C7)', 'm_c7w'], ['Wrist Ext (C6)', 'm_c6w'], ['Hand Grip (C8)', 'm_c8'],
            ['Hip Flex (L2)', 'm_l2'], ['Knee Ext (L3)', 'm_l3'], ['Knee Flex (L5)', 'm_l5'],
            ['Ankle Dorsi (L4)', 'm_l4a'], ['Ankle Plantar (S1)', 'm_s1']
        ];
        muscles.forEach(item => createSlider('motor_sliders', item[0], item[1]));

        // Init DTR inputs
        const dtrC = document.getElementById('dtr_list');
        ['Biceps(C5)', 'Triceps(C7)', 'Brach(C6)', 'Knee(L4)', 'Ankle(S1)'].forEach(d => {
            const div = document.createElement('div');
            div.className = 'form-row';
            div.innerHTML = `<label>${d}</label><input type="text" id="ref_${d.split('(')[0]}" value="++/++" class="monitored" data-normal="++/++">`;
            dtrC.appendChild(div);
        });

        // Init EOM
        createEOMGrid('grid_r', 'er');
        createEOMGrid('grid_l', 'el');

        // Monitoring for Abnormal Summary
        document.querySelectorAll('.monitored').forEach(el => {
            el.addEventListener('input', () => checkCardAbnormal(el.closest('.card')));
            el.addEventListener('change', () => checkCardAbnormal(el.closest('.card')));
        });
        
        generateReport();
    }

    // Expand/Collapse + Summary Update
    function toggleCard(header) {
        const body = header.nextElementSibling;
        const arrow = header.querySelector('span:first-child');
        
        if(body.classList.contains('collapsed')) {
            body.classList.remove('collapsed');
            arrow.innerText = arrow.innerText.replace('▶', '▼');
        } else {
            body.classList.add('collapsed');
            arrow.innerText = arrow.innerText.replace('▼', '▶');
        }
    }

    function checkCardAbnormal(card) {
        if(!card) return;
        const inputs = card.querySelectorAll('.monitored');
        const summaryEl = card.querySelector('.abnormal-summary');
        let abnormals = [];

        inputs.forEach(inp => {
            const isToggle = inp.classList.contains('toggle-input');
            const normal = inp.dataset.normal;
            const val = inp.value;

            if(val != normal) {
                let label = "";
                if(isToggle) {
                    label = inp.parentElement.dataset.label;
                } else {
                    const row = inp.closest('.form-row');
                    if(row) label = row.querySelector('label').innerText;
                    else label = inp.id; // Fallback
                }
                // Don't duplicate labels
                if(label && !abnormals.includes(label)) abnormals.push(label);
            }
        });

        if(abnormals.length > 0) {
            summaryEl.innerText = "⚠ " + abnormals.join(", ");
        } else {
            summaryEl.innerText = "";
        }
    }

    // --- 3. Report Generation ---

    function getVal(id) {
        const el = document.getElementById(id);
        return el ? el.value : '';
    }
    
    // Get toggle value by container ID
    function getTog(id) { 
        // The id passed is the span/container id (e.g. 'lr_l'), we need the input inside
        const c = document.getElementById(id); 
        return c.querySelector('input').value; 
    }

    function getPrim() {
        // Collect all primitives
        let res = [];
        const inputs = document.querySelectorAll('#prim_container .toggle-input');
        inputs.forEach(inp => {
            const name = inp.parentElement.dataset.label;
            res.push(`${name} (${inp.value})`);
        });
        return res.join(', ');
    }

    function getEOM() {
        // Check if all are 0
        const allInputs = document.querySelectorAll('.eye-input');
        let allZero = true;
        allInputs.forEach(i => { if(i.value !== '0') allZero = false; });

        if(allZero) return "EOM: intact, no gaze limitation";

        // Generate ASCII
        const v = (id) => document.getElementById(id).value;
        return `EOM:
              ${v('er_t')}                ${v('el_t')}
              |                | 
        ${v('er_l')} --- ${v('er_c')} --- ${v('er_r')}    ${v('el_l')} --- ${v('el_c')} --- ${v('el_r')}
              |                | 
              ${v('er_b')}                ${v('el_b')}`;
    }

    function generateReport() {
        const txt = `#. E${getVal('gcs_e')}V${getVal('gcs_v')}M${getVal('gcs_m')}, ${getVal('gcs_status')}
#. NIHSS: ${getVal('nihss_detail')} = ${getVal('nihss_total')}

--- Cognition ---
#. High cortical function
  - Category naming: ${getVal('cog_cat')}
  - Luria test: ${getVal('cog_luria')}
  - Letter number seq: ${getVal('cog_seq')}
  - Primitive reflex: ${getPrim()}
#. Language
  - Fluency: ${getVal('lang_fluency')}
  - Comprehension: ${getVal('lang_comp')}
  - Reading: ${getVal('lang_read')}
  - Naming: ${getVal('lang_name')}
  - Repeating: ${getVal('lang_repeat')}
#. Neglect
  - ${getVal('neglect')}

--- Cranial Nerves ---
#. CN I: ${getVal('cn1')}
#. CN II: 
  - Visual field: ${getVal('cn2_vf')}
  - Pupil: ${getVal('cn2_pupil')}
  - Light reflex: L(${getTog('lr_l')}) / R(${getTog('lr_r')})
#. CN III, IV, VI:
  - ${getEOM()}
  - Nystagmus (${getTog('nystagmus_toggle')})
  - Ptosis (${getTog('ptosis_toggle')})
  - Saccade: ${getVal('cn3_saccade')}
  - Pursuit: ${getVal('cn3_pursuit')}
  - Convergence: ${getVal('cn3_conv')}
#. CN V:
  - Corneal reflex: L(${getTog('cor_l')}) / R(${getTog('cor_r')})
  - Facial sensation: ${getVal('cn5_sens')}
  - Masseter: ${getVal('cn5_mass')}
#. CN VII:
  - Face: ${getVal('cn7_face')}
  - Eye closure: ${getVal('cn7_eye')}
  - Fold: ${getVal('cn7_fold')}
#. CN VIII:
  - Hearing: ${getVal('cn8_hear')}
  - Weber/Rinne: ${getVal('cn8_tune')}
#. CN IX, X:
  - Gag reflex: L(${getTog('gag_l')}) / R(${getTog('gag_r')})
  - Uvula: ${getVal('cn9_uvula')}
  - Dysarthria/Dysphagia: ${getVal('cn9_dys')}
#. CN XI:
  - Trap/SCM: ${getVal('cn11_trap')}
#. CNXII:
  - Tongue: ${getVal('cn12_tongue')}

--- Motor ---
#. Motor inspection: ${getVal('mot_insp')}
#. Muscle tone: ${getVal('mot_tone')}
#. Muscle strength:
  - Shoulder Abd (C5): ${getVal('m_c5')}
  - Elbow Flex (C6): ${getVal('m_c6')}
  - Elbow Ext (C7): ${getVal('m_c7')}
  - Wrist Flex (C7): ${getVal('m_c7w')}
  - Wrist Ext (C6): ${getVal('m_c6w')}
  - Pinky Abd (C8): ${getVal('m_c8')}
  - Hip Flex (L2): ${getVal('m_l2')}
  - Knee Ext (L3): ${getVal('m_l3')}
  - Knee Flex (L5): ${getVal('m_l5')}
  - Ankle Dorsi (L4): ${getVal('m_l4a')}
  - Ankle Plantar (S1): ${getVal('m_s1')}

--- Reflex ---
#. DTR:
  - Biceps: ${getVal('ref_Biceps')}
  - Triceps: ${getVal('ref_Triceps')}
  - Brach: ${getVal('ref_Brach')}
  - Knee: ${getVal('ref_Knee')}
  - Ankle: ${getVal('ref_Ankle')}
  
  - Babinski: ${getVal('ref_bab')}
  - Hoffman: ${getVal('ref_hoff')}
  - Tromner: ${getVal('ref_trom')}

--- Sensory ---
#. Small fiber: ${getVal('sen_touch')}
#. Large fiber:
  - Proprioception: ${getVal('sen_prop')}
  - Vibration: ${getVal('sen_vib')}

--- Coordination ---
#. FNF: ${getVal('coor_fnf')}
#. HKS: ${getVal('coor_hks')}
#. RAM: ${getVal('coor_ram')}
#. Rebound: ${getVal('coor_reb')}
#. Truncal: ${getVal('coor_trunk')}

--- Posture/Gait ---
#. Romberg: (${getTog('romberg_toggle')})
#. Gait: ${getVal('gait_pat')}
#. Tandem: ${getVal('gait_tandem')}
  
--- Extrapyramidal system (EPS) ---
#. Face/Arm: ${getVal('eps_face')}
#. Tremor: ${getVal('eps_tremor')}
#. Rigidity: ${getVal('eps_rigid')}
#. Bradykinesia: ${getVal('eps_brady')}
#. Gait: ${getVal('eps_gait')}

--- Autonomic ---
#. Sphincters: ${getVal('auto_sph')}
#. Dizziness: ${getVal('auto_diz')}
#. Sweating: ${getVal('auto_sweat')}
`;
        document.getElementById('result').value = txt;
    }

    function copyResult() {
        const el = document.getElementById('result');
        el.select();
        document.execCommand('copy');
    }

    function resetDefaults() {
        if(confirm("Reset all?")) location.reload();
    }

</script>
</body>
</html>